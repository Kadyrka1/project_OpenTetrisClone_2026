#include <FastLED.h>

#define LED_PIN     23        // GPIO23 on your board
#define NUM_LEDS    100        // change to your strip length
#define BRIGHTNESS  80        // 0-255 (keep modest if power is limited)
#define LED_TYPE    WS2812B   // WS2813 uses the same protocol as WS2812B
#define COLOR_ORDER GRB

CRGB leds[NUM_LEDS];
bool isOn[NUM_LEDS] = {false};

String readLine() {
  static String line = "";
  while (Serial.available()) {
    char c = (char)Serial.read();
    if (c == '\r') continue;
    if (c == '\n') {
      String out = line;
      line = "";
      out.trim();
      return out;
    }
    line += c;
  }
  return "";
}

void applyState() {
  for (int i = 0; i < NUM_LEDS; i++) {
    leds[i] = isOn[i] ? CRGB::White : CRGB::Black;
  }
  FastLED.show();
}

void setup() {
  Serial.begin(115200);
  delay(200);

  FastLED.addLeds<LED_TYPE, LED_PIN, COLOR_ORDER>(leds, NUM_LEDS);
  FastLED.setBrightness(BRIGHTNESS);

  // Start off
  for (int i = 0; i < NUM_LEDS; i++) isOn[i] = false;
  applyState();

  Serial.println("WS2813 Controller Ready");
  Serial.println("Commands:");
  Serial.println("  <n>        -> toggle LED n (0..9)");
  Serial.println("  on <n>     -> force ON");
  Serial.println("  off <n>    -> force OFF");
  Serial.println("  clear      -> all OFF");
  Serial.println("  white      -> all ON (white)");
  Serial.println("  status     -> list ON LEDs");
}

void loop() {
  String cmd = readLine();
  if (cmd.length() == 0) return;

  cmd.toLowerCase();

  auto printInvalid = []() {
    Serial.println("Invalid. Use: <n>, on <n>, off <n>, clear, white, status");
  };

  if (cmd == "clear") {
    for (int i = 0; i < NUM_LEDS; i++) isOn[i] = false;
    applyState();
    Serial.println("All OFF");
    return;
  }

  if (cmd == "white") {
    for (int i = 0; i < NUM_LEDS; i++) isOn[i] = true;
    applyState();
    Serial.println("All ON (white)");
    return;
  }

  if (cmd == "status") {
    Serial.print("ON LEDs: ");
    bool any = false;
    for (int i = 0; i < NUM_LEDS; i++) {
      if (isOn[i]) {
        Serial.print(i);
        Serial.print(" ");
        any = true;
      }
    }
    if (!any) Serial.print("(none)");
    Serial.println();
    return;
  }

  // Commands: "on n" or "off n" or just "n"
  if (cmd.startsWith("on ")) {
    int n = cmd.substring(3).toInt();
    if (n >= 0 && n < NUM_LEDS) {
      isOn[n] = true;
      applyState();
      Serial.printf("LED %d -> ON\n", n);
    } else printInvalid();
    return;
  }

  if (cmd.startsWith("off ")) {
    int n = cmd.substring(4).toInt();
    if (n >= 0 && n < NUM_LEDS) {
      isOn[n] = false;
      applyState();
      Serial.printf("LED %d -> OFF\n", n);
    } else printInvalid();
    return;
  }

  // If it's just a number, toggle
  bool isNumber = true;
  for (int i = 0; i < (int)cmd.length(); i++) {
    if (!isDigit(cmd[i])) { isNumber = false; break; }
  }

  if (isNumber) {
    int n = cmd.toInt();
    if (n >= 0 && n < NUM_LEDS) {
      isOn[n] = !isOn[n];
      applyState();
      Serial.printf("LED %d -> %s\n", n, isOn[n] ? "ON" : "OFF");
    } else printInvalid();
    return;
  }

  printInvalid();
}
